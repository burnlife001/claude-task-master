


# 支持第三方API的MCP服务器修改指南

基于对 `eyaltoledano/claude-task-master` 项目的全面分析，以下是支持第三方API (THIRD_API_KEY, THIRD_BASE_URL)所需修改的所有地方：

## 1. 配置管理层修改

### 1.1 环境变量映射更新
需要在配置管理器中添加第三方API密钥映射： config-manager.js:487-498

### 1.2 API密钥状态检查更新
需要更新MCP配置中的API密钥状态检查： config-manager.js:553-594

### 1.3 环境变量解析函数更新
需要在AI服务统一层中更新API密钥解析逻辑： ai-services-unified.js:163-176

## 2. AI服务提供者层修改

### 2.1 提供者实例注册
需要在AI服务统一层中注册新的第三方提供者： ai-services-unified.js:45-57

### 2.2 创建新的第三方AI提供者类
需要在AI提供者目录中创建新的第三方提供者类，基于现有的基类： base-provider.js:7-26

### 2.3 更新提供者索引文件
需要更新AI提供者的索引文件以导出新的第三方提供者。

## 3. 模型配置更新

### 3.1 支持模型列表更新
需要在支持的模型JSON文件中添加第三方提供者的模型配置： supported-models.json:1-31

### 3.2 模型验证逻辑更新
需要更新模型管理器中的提供者提示处理逻辑，以支持第三方提供者： models.js:430-494

## 4. MCP工具层修改

### 4.1 模型工具参数更新
需要更新MCP模型工具的参数验证，以支持第三方提供者标志： models.js:51-59

### 4.2 直接函数参数处理
需要更新模型直接函数以处理第三方提供者参数： models.js:34-46

## 5. 环境变量和配置文件

### 5.1 环境变量文档更新
需要在项目文档中添加THIRD_API_KEY和THIRD_BASE_URL的说明。

### 5.2 默认配置更新
需要在配置管理器的默认配置中考虑第三方提供者的基础URL配置： config-manager.js:64-66

## 6. 具体实现步骤

### 第一步：创建第三方AI提供者类
1. 在 `src/ai-providers/` 目录下创建 `third-party.js`
2. 继承 `BaseAIProvider` 类
3. 实现必要的验证和客户端创建方法

### 第二步：更新配置系统
1. 在 `config-manager.js` 中添加 `third-party` 到提供者映射
2. 更新API密钥验证逻辑
3. 添加第三方基础URL支持

### 第三步：更新AI服务层
1. 在 `ai-services-unified.js` 中注册第三方提供者实例
2. 更新环境变量解析逻辑
3. 确保统一服务运行器支持新提供者

### 第四步：更新模型配置
1. 在 `supported-models.json` 中添加第三方模型配置
2. 更新模型验证和设置逻辑
3. 添加第三方提供者提示支持

### 第五步：更新MCP工具
1. 在模型工具中添加第三方提供者标志参数
2. 更新参数验证逻辑
3. 确保工具能正确处理第三方配置

## Notes

此修改涉及多个架构层次，从底层的AI提供者实现到顶层的MCP工具接口。核心思路是遵循现有的提供者模式，通过添加新的第三方提供者类并在各个配置和服务层中注册支持。关键是保持与现有OpenRouter和Ollama自定义提供者相同的扩展模式，确保配置验证、API密钥管理和模型验证的一致性。
